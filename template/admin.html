<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel de Administra√ß√£o - OLN Log√≠stica</title>
    <style>
        /* Regras gerais para todos os dispositivos */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            /* Remover margem padr√£o do body para mais espa√ßo nas bordas */
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        * {
            box-sizing: border-box;
            /* Essencial para que padding e border sejam inclu√≠dos na largura/altura */
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            /* Margem superior/inferior de 20px, centralizado */
            padding: 25px;
            /* Aumenta o padding do cont√™iner */
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
            /* Sombra mais vis√≠vel */
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            /* Mais espa√ßo abaixo do t√≠tulo */
            font-size: 2.2em;
            /* T√≠tulo principal um pouco maior */
            color: #333;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 35px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            color: #444;
        }

        .form-group {
            margin-bottom: 25px;
            /* Aumenta ainda mais o espa√ßamento entre os grupos de formul√°rio */
        }

        label {
            display: block;
            margin-bottom: 10px;
            /* Mais espa√ßo abaixo do label */
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
            /* Fonte do label um pouco maior */
        }

        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            /* Aumenta o padding interno, especialmente lateral */
            font-size: 1.1em;
            /* Tamanho da fonte dos inputs */
            border: 1px solid #ccc;
            border-radius: 6px;
            /* Bordas levemente mais arredondadas */
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            /* Adiciona um brilho ao focar */
            outline: none;
        }

        /* Estilo para par√°grafos dentro de form-group (instru√ß√µes) */
        .form-group p {
            font-size: 0.9em;
            /* Mant√©m o tamanho das instru√ß√µes menor que o label e input */
            color: #666;
            margin-top: 5px;
            margin-bottom: 10px;
            /* Garante espa√ßo suficiente antes do input */
        }

        /* Estilo para o checkbox */
        input[type="checkbox"] {
            margin-right: 10px;
            /* Espa√ßo entre o checkbox e o texto */
            transform: scale(1.2);
            /* Aumenta o tamanho do checkbox */
        }

        button {
            padding: 12px 25px;
            /* Mais padding para os bot√µes */
            margin: 8px 5px 8px 0;
            /* Margem ajustada para melhor distribui√ß√£o */
            font-size: 1.05em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            /* Efeito sutil ao passar o mouse */
        }

        #startBtn {
            background-color: #4CAF50;
            color: white;
        }

        #startBtn:hover {
            background-color: #45a049;
        }

        #stopBtn {
            background-color: #f44336;
            color: white;
        }

        #stopBtn:hover {
            background-color: #da190b;
        }

        /* Estilos para os outros bot√µes */
        #downloadHashBtn {
            background-color: #1976D2;
            color: white;
        }

        #downloadHashBtn:hover {
            background-color: #115da3;
        }

        #archiveLogBtn {
            background-color: #388e3c;
            color: white;
        }

        #archiveLogBtn:hover {
            background-color: #2e7031;
        }

        #downloadLogsBtn {
            background-color: #6d4c41;
            color: white;
        }

        #downloadLogsBtn:hover {
            background-color: #5a3e36;
        }

        /* Quebra de linha para bot√µes menores em mobile */
        .button-group-bottom {
            /* Adicione uma div com essa classe em torno dos tr√™s bot√µes de baixo */
            display: flex;
            flex-wrap: wrap;
            /* Permite que os itens quebrem linha */
            justify-content: center;
            /* Centraliza os bot√µes quando quebram */
            gap: 10px;
            /* Espa√ßamento entre os bot√µes */
            margin-top: 20px;
        }

        /* ... (restante do seu CSS para status, logOutput, etc.) */

        .status {
            display: block;
            margin-top: 20px;
            /* Mais espa√ßo acima do status */
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #2196F3;
            font-weight: bold;
            text-align: center;
        }

        #logOutput {
            margin-top: 25px;
            padding: 18px;
            /* Mais padding no log */
            background: #fdfdfd;
            border: 1px solid #ddd;
            border-radius: 6px;
            white-space: pre-wrap;
            max-height: 450px;
            /* Altura m√°xima ligeiramente maior */
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #333;
            line-height: 1.4;
            /* Melhora a legibilidade do log */
        }

        .log-header {
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
            text-align: center;
            font-size: 1.3em;
        }

        /* MEDIA QUERIES PARA CELULARES */
        @media (max-width: 600px) {
            body {
                margin: 0;
                /* Remove margens do body para m√°xima utiliza√ß√£o do espa√ßo */
                font-size: 14px;
                /* Tamanho base da fonte um pouco menor no geral para celular */
            }

            .container {
                margin: 0;
                /* Remove margem superior/inferior em mobile */
                padding: 15px;
                /* Reduz o padding para n√£o apertar demais */
                border-radius: 0;
                /* Remove border-radius para ocupar 100% da largura */
                box-shadow: none;
                /* Remove sombra em mobile para um visual mais limpo */
            }

            h1 {
                font-size: 1.6em;
                /* Reduz mais o tamanho do t√≠tulo principal */
                margin-bottom: 15px;
            }

            h2 {
                font-size: 1.3em;
                margin-top: 25px;
                margin-bottom: 10px;
            }

            .form-group {
                margin-bottom: 18px;
                /* Espa√ßamento entre grupos */
            }

            label {
                font-size: 1em;
                /* Ajusta o tamanho do label */
                margin-bottom: 6px;
            }

            /* Aumenta significativamente o padding e a fonte dos inputs para celular */
            input[type="text"],
            input[type="number"],
            input[type="password"] {
                padding: 16px 12px;
                /* Padding maior para facilitar o toque */
                font-size: 1.15em;
                /* Garante fonte grande o suficiente nos inputs */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border-radius: 4px;
                /* Mant√©m um pequeno arredondamento */
            }

            .form-group p {
                font-size: 0.85em;
                /* Reduz o tamanho das instru√ß√µes para otimizar espa√ßo */
                margin-top: 2px;
                margin-bottom: 6px;
            }

            input[type="checkbox"] {
                transform: scale(1.1);
                /* Ajusta o tamanho do checkbox para celular */
                margin-right: 8px;
            }

            button {
                width: 100%;
                /* Bot√µes sempre com largura total em mobile */
                margin: 6px 0;
                /* Margem vertical ajustada */
                padding: 16px;
                /* Padding maior para bot√µes em mobile */
                font-size: 1em;
                /* Ajusta a fonte dos bot√µes */
            }

            .button-group-bottom {
                flex-direction: column;
                /* For√ßa os bot√µes a ficarem em coluna */
                gap: 8px;
                /* Espa√ßamento entre os bot√µes */
                margin-top: 15px;
            }

            .status {
                font-size: 0.95em;
                margin-top: 15px;
                margin-bottom: 10px;
            }

            #logOutput {
                max-height: 250px;
                /* Reduz a altura m√°xima do log para telas menores */
                padding: 12px;
                font-size: 0.8em;
                /* Fonte do log menor para caber mais conte√∫do */
            }

            .log-header {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
        }

        /* Media Query para telas muito pequenas, como iPhone 5/SE */
        @media (max-width: 375px) {
            body {
                font-size: 13px;
                /* Reduz um pouco mais a fonte base */
            }

            h1 {
                font-size: 1.5em;
            }

            h2 {
                font-size: 1.2em;
            }

            input[type="text"],
            input[type="number"],
            input[type="password"] {
                padding: 14px 10px;
                /* Padding ligeiramente menor para inputs */
                font-size: 1.1em;
            }

            button {
                padding: 14px;
                /* Padding dos bot√µes */
                font-size: 0.95em;
            }

            #logOutput {
                max-height: 200px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Painel de Procura do MarketRoxo</h1>
        <div class="form-group">
            <label for="keywords">Palavras-chave (separadas por v√≠rgula):</label>
            <input type="text" id="keywords" value="{{ keywords_list }}" oninput="updateSubsetCount()">
        </div>
        <div class="form-group">
            <label for="negativeKeywords">Palavras-chave negativas (separadas por v√≠rgula):</label>
            <input type="text" id="negativeKeywords" value="{{ negative_keywords_list }}">
        </div>
        <div class="form-group">
            <label for="token">Token do Telegram:</label>
            <input type="password" id="token" value="{{ token }}" autocomplete="new-password">
        </div>
        <div class="form-group">
            <label for="chatInput">ID do Chat ou N√∫mero de Telefone:</label>
            <input type="text" id="chatInput" value="{{ chat_input }}">
        </div>
        <div class="form-group">
            <label for="interval_monitor">Tempo entre intervalos de Varredura (minutos):</label>
            <p>Tempo longo de intervalo entre a varredura de m√∫ltiplas p√°ginas.</p>
            <input type="number" id="interval_monitor" value="{{ interval_monitor }}" min="1">
        </div>
        <div class="form-group">
            <label for="batch_size">An√∫ncios por mensagem:</label>
            <p>Quantos an√∫ncios o programa vai enviar por mensagem no Telegram.</p>
            <p>Com 1 mensagem, ser√£o exibidas as miniaturas(fotos) dos an√∫ncios. </p>
            <input type="number" id="batch_size" value="{{ batch_size }}" min="1" max="18">
        </div>
        <div class="form-group">
            <label for="pageDepth">Profundidade de p√°ginas:</label>
            <p>Quantas p√°ginas a varredura deve procurar, al√©m da p√°gina 1.</p>
            <p>Ap√≥s obter muitos resultados, se a inten√ß√£o for apenas atualizar, √© recomend√°vel reduzir.</p>
            <input type="number" id="pageDepth" value="{{ page_depth }}" min="1">
        </div>
        <div class="form-group">
            <label for="retryAttempts">Tentativas at√© sucesso:</label>
            <p>Quantas vezes ele deve repetir uma chamada de p√°gina para tentar burlar bloqueios.</p>
            <input type="number" id="retryAttempts" value="{{ retry_attempts }}" min="1">
        </div>
        <div class="form-group">
            <label for="minRepeatTime">Tempo m√≠nimo p/ repetir (segundos):</label>
            <p>Tempo m√≠nimo entre tentativas de repeti√ß√£o, para evitar bloqueios.</p>
            <input type="number" id="minRepeatTime" value="{{ min_repeat_time }}" min="1">
        </div>
        <div class="form-group">
            <label for="maxRepeatTime">Tempo m√°ximo p/ repetir (segundos):</label>
            <p>Tempo m√°ximo entre tentativas de repeti√ß√£o, para evitar bloqueios.</p>
            <input type="number" id="maxRepeatTime" value="{{ max_repeat_time }}" min="1">
        </div>
        <div class="form-group">
            <label for="min_subset_size">Tamanho M√≠nimo do Subconjunto:</label>
            <p>Define o valor m√≠nimo para o tamanho dos subconjunto (padr√£o √© 3). (ABC,CDE,DBC) de um (ABCDE)</p>
            <input type="number" id="min_subset_size" value="{{ min_subset_size }}" min="1">
        </div>
        <div class="form-group">
            <label for="max_subset_size">Tamanho M√°ximo do Subconjunto:</label>
            <p>Define o valor m√°ximo para tamanho dos subconjunto (padr√£o √© o total de palavras-chave).</p>
            <input type="number" id="max_subset_size" value="{{ max_subset_size }}" min="1">
        </div>
        <div class="form-group">
            <label for="send_as_batch">Permitir enviar a cada procura:</label>
            <p> Torna os envios mais frequentes, ao inv√©s de esperar o ciclo completo.</p>
            <p> Melhor ativar para tentativas grandes, com muitas op√ß√µes selecionadas.</p>
            <input type="checkbox" id="send_as_batch" {{ 'checked' if send_as_batch else '' }}>
        </div>
        <div class="form-group">
            <label for="allowKeywordSubsets">Permitir subconjuntos das palavras-chave:</label>
            <p> Cuidado ao usar: com proxy, isso faz mais chamadas e gasta mais cr√©ditos. Bom para tentar achar
                resultados diferentes.</p>
            <input type="checkbox" id="allowKeywordSubsets" {{ 'checked' if allow_keyword_subsets else '' }}>
        </div>
        <div class="form-group">
            <label for="number_set">Quantos SubConjuntos:</label>
            <p>Subconjuntos √© o n√∫mero de combina√ß√µes das palavras chaves, p/ tentar achar anuncios diferentes, minimo 3.</p>
            <p>Em um conjunto (A,B,C), os subconjuntos s√£o: (ABC, BC, AB, AC,A,B,C), ele vai sortear X subconjuntos p/ usar. </p>
            <input type="number" id="number_set" value="{{ number_set }}" min="3" oninput="updateSubsetCount()">
            <span id="subsetCount" style="margin-left:10px; font-weight:bold;"></span>
        </div>
        <!-- BOT√ïES -->
        <h2>Controle do monitor de procura </h2>
        <p>Ao trocar valores √© bom parar para interromper qualquer busca, e iniciar ap√≥s. Sem iniciar os valores novos
            n√£o s√£o salvos no servidor. </p>
        <button id="startBtn" onclick="startMonitoring()">Iniciar Monitoramento</button>
        <button id="stopBtn" onclick="stopMonitoring()">Parar Monitoramento</button>
        <br>
        <button id="downloadHashBtn" style="background-color:#1976D2;color:white;"
            onclick="window.open('/download-hash-file','_blank')">‚¨áÔ∏è Baixar Hash File</button>
        <button id="archiveLogBtn" style="background-color:#388e3c;color:white;"
            onclick="fetch('/archive_log', {method: 'GET'}).then(r => r.json()).then(data => alert(data.message)).catch(e => alert('Erro ao arquivar log: ' + e));">üÜï
            Arquivar Log Atual</button>
        <button id="downloadLogsBtn" style="background-color:#6d4c41;color:white;"
            onclick="window.open('/download-logs','_blank')">üì¶ Baixar Todos Logs</button>
        <br>
        <span id="autoUpdateStatus" class="status">Carregando logs...</span>
        <div class="log-header">Logs do Sistema (Atualiza√ß√£o Autom√°tica)</div>
        <button id="scrollLogBtn" style="background-color:#ffa726;color:white;margin-bottom:10px;" onclick="scrollToLogBottom()">‚¨áÔ∏è Ir para o fim do log</button>
        <pre id="logOutput">Carregando logs...</pre>
    </div>
    <script>
        // --- Subset count script ---
        function comb(n, k) {
            if (k > n) return 0;
            let num = 1, denom = 1;
            for (let i = 1; i <= k; i++) {
            num *= (n - i + 1);
            denom *= i;
            }
            return num / denom;
        }

        function updateSubsetCount() {
            // Use keywords from the keywords input
            const rawKeywords = document.getElementById('keywords').value;
            const keywords = rawKeywords.split(',')
            .map(kw => kw.trim())
            .filter(kw => kw.length);
            const n = keywords.length;
            if (n === 0) {
            document.getElementById('subsetCount').textContent = '';
            return;
            }
            const minSubsetSize = n >= 3 ? 3 : n;
            let totalSubsets = 0;
            for (let i = minSubsetSize; i <= n; i++) {
            totalSubsets += comb(n, i);
            }
            document.getElementById('subsetCount').textContent =
            'Subconjuntos (' + minSubsetSize + ' a ' + n + '): ' + totalSubsets;
        }

        // Inicializa√ß√£o ao carregar a p√°gina e sempre que keywords ou number_set mudarem
        document.addEventListener('DOMContentLoaded', function () {
            updateSubsetCount();
            document.getElementById('keywords').addEventListener('input', updateSubsetCount);
            document.getElementById('min_subset_size').addEventListener('input', updateSubsetCount);
            document.getElementById('max_subset_size').addEventListener('input', updateSubsetCount);
            // Se voc√™ quiser atualizar o subset count quando o n√∫mero de subconjuntos mudar,
            // document.getElementById('number_set').addEventListener('input', updateSubsetCount);
        });
        // --- Fim do subset count script ---

        let logUpdateInterval = null;

        // Fun√ß√£o para iniciar atualiza√ß√£o autom√°tica dos logs
        function startAutoUpdate() {
            if (!logUpdateInterval) {
                logUpdateInterval = setInterval(fetchLogs, 2000); // Atualiza a cada 2 segundos
                document.getElementById('autoUpdateStatus').textContent = 'Atualiza√ß√£o autom√°tica: Ativada';
            }
        }

        // Fun√ß√£o para parar atualiza√ß√£o autom√°tica
        function stopAutoUpdate() {
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
                document.getElementById('autoUpdateStatus').textContent = 'Atualiza√ß√£o autom√°tica: Desativada';
            }
        }

        // Fun√ß√£o para descer at√© o fim do log
        function scrollToLogBottom() {
            const logOutput = document.getElementById('logOutput');
            logOutput.scrollTop = logOutput.scrollHeight;
        }


        // Fun√ß√£o para buscar os logs
        function fetchLogs() {
            fetch('/logs', {
                headers: {
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar logs: ' + response.status);
                    }
                    return response.text();
                })
                .then(data => {
                    const logOutput = document.getElementById('logOutput');
                    // Filter out lines containing "GET /logs HTTP/1.1" 200
                    const filteredData = data.split('\n').filter(line => !line.includes('GET /logs HTTP/1.1')).join('\n');
                    logOutput.textContent = filteredData || 'Nenhum log dispon√≠vel';
                    // Remove or comment out the auto-scroll line
                    // logOutput.scrollTop = logOutput.scrollHeight;
                })
                .catch(error => {
                    console.error('Erro ao carregar logs:', error);
                    document.getElementById('logOutput').textContent = 'Erro ao carregar logs: ' + error.message;
                });
        }

        function startMonitoring() {
            const data = {
                keywords_list: document.getElementById('keywords').value,
                negative_keywords_list: document.getElementById('negativeKeywords').value,
                token: document.getElementById('token').value,
                chat_input: document.getElementById('chatInput').value,
                interval_monitor: document.getElementById('interval_monitor').value,
                batch_size: document.getElementById('batch_size').value,
                page_depth: document.getElementById('pageDepth').value,
                retry_attempts: document.getElementById('retryAttempts').value,
                min_repeat_time: document.getElementById('minRepeatTime').value,
                max_repeat_time: document.getElementById('maxRepeatTime').value,
                number_set: document.getElementById('number_set').value,
                allow_subset: document.getElementById('allowKeywordSubsets').checked,
                min_subset_size: document.getElementById('min_subset_size').value,
                max_subset_size: document.getElementById('max_subset_size').value,
                send_as_batch: document.getElementById('send_as_batch').checked
            };

            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    // Os logs j√° est√£o sendo atualizados automaticamente
                })
                .catch(error => {
                    console.error('Erro ao iniciar monitoramento:', error);
                    alert('Erro ao iniciar monitoramento: ' + error.message);
                });
        }

        function stopMonitoring() {
            fetch('/stop', {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                }
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    // Os logs continuam sendo atualizados automaticamente
                })
                .catch(error => {
                    console.error('Erro ao parar monitoramento:', error);
                    alert('Erro ao parar monitoramento: ' + error.message);
                });
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function () {
            console.log('P√°gina carregada, iniciando atualiza√ß√£o autom√°tica de logs...');
            fetchLogs(); // Carrega os logs imediatamente
            startAutoUpdate(); // Inicia a atualiza√ß√£o autom√°tica
        });

        // Parar a atualiza√ß√£o quando a p√°gina for fechada/recarregada
        window.addEventListener('beforeunload', function () {
            stopAutoUpdate();
        });
    </script>
</body>

</html>