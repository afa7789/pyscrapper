<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Administração - OLN Logística</title>
    <style>
        /* Regras gerais para todos os dispositivos */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            line-height: 1.6; /* Melhora a legibilidade do texto */
        }
        /* Adicionar box-sizing globalmente é uma boa prática para layouts responsivos */
        * {
            box-sizing: border-box;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Adiciona uma sombra suave */
        }
        h1 {
            text-align: center;
            margin-bottom: 25px; /* Adiciona mais espaço abaixo do título principal */
            font-size: 2em; /* Tamanho do título principal */
        }
        h2 { /* Adicionar estilo para h2, se aplicável */
            font-size: 1.6em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .form-group {
            margin-bottom: 20px; /* Aumenta o espaçamento entre os grupos de formulário */
        }
        label {
            display: block;
            margin-bottom: 8px; /* Aumenta o espaçamento abaixo do label */
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        input[type="number"],
        input[type="password"], /* Incluir input[type="password"] aqui */
        textarea { /* Adicionar textarea, caso venha a ter */
            width: 100%; /* Faz com que o input ocupe 100% da largura do contêiner pai */
            padding: 10px; /* Aumenta o padding para melhor toque e visual */
            font-size: 1.1em; /* Tamanho da fonte dos inputs, relativo ao body font-size */
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.3s; /* Adiciona transição suave para foco */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            border-color: #007bff; /* Muda a cor da borda ao focar */
            outline: none; /* Remove o outline padrão */
        }

        /* Estilo para parágrafos dentro de form-group (instruções) */
        .form-group p {
            font-size: 0.9em; /* slightly smaller than base font, but still readable */
            color: #666;
            margin-top: 5px;
            margin-bottom: 10px; /* Space before input */
        }

        button {
            padding: 10px 20px;
            margin: 5px 5px 5px 0; /* Ajusta a margem dos botões */
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        #startBtn { background-color: #4CAF50; color: white; }
        #startBtn:hover { background-color: #45a049; }
        #stopBtn { background-color: #f44336; color: white; }
        #stopBtn:hover { background-color: #da190b; }
        #downloadHashBtn { background-color:#1976D2;color:white; }
        #downloadHashBtn:hover { background-color: #115da3; }
        #archiveLogBtn { background-color:#388e3c;color:white; }
        #archiveLogBtn:hover { background-color: #2e7031; }
        #downloadLogsBtn { background-color:#6d4c41;color:white; }
        #downloadLogsBtn:hover { background-color: #5a3e36; }

        .status {
            display: block; /* Mude para block para ocupar a própria linha */
            margin-top: 15px; /* Espaço acima do status */
            margin-bottom: 10px;
            font-size: 1.05em;
            color: #2196F3;
            font-weight: bold;
            text-align: center; /* Centraliza o texto de status */
        }
        #logOutput {
            margin-top: 20px;
            padding: 15px; /* Aumenta o padding do log output */
            background: #fdfdfd; /* Cor de fundo mais clara para o log */
            border: 1px solid #ddd; /* Borda mais suave */
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace; /* Fonte monoespaçada para logs */
            font-size: 0.9em; /* Tamanho da fonte do log */
            color: #333;
        }
        .log-header {
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
            text-align: center; /* Centraliza o cabeçalho do log */
            font-size: 1.2em;
        }

        /* MEDIA QUERIES PARA CELULARES */
        @media (max-width: 600px) {
            body {
                margin: 10px; /* Reduz a margem geral do corpo */
                font-size: 15px; /* Base da fonte um pouco menor para celular */
            }

            .container {
                padding: 15px; /* Reduz o padding do contêiner */
            }

            h1 {
                font-size: 1.8em; /* Reduz o tamanho do título principal */
                margin-bottom: 20px;
            }
            h2 {
                font-size: 1.4em;
                margin-top: 20px;
                margin-bottom: 10px;
            }

            /* Aumenta o tamanho dos inputs e seu padding para facilitar o toque no celular */
            input[type="text"],
            input[type="number"],
            input[type="password"],
            textarea {
                padding: 14px; /* Aumenta o padding consideravelmente */
                font-size: 1.15em; /* Garante que a fonte do input seja bem legível */
                -webkit-appearance: none; /* Remove estilos padrão de input em iOS */
                -moz-appearance: none;    /* Remove estilos padrão de input em Firefox Mobile */
                appearance: none;         /* Estilo padrão */
                border-radius: 6px; /* Levemente mais arredondado para celular */
            }

            .form-group p {
                font-size: 0.95em; /* Garante que os textos de instrução sejam legíveis */
                margin-top: 3px;
                margin-bottom: 8px;
            }

            label {
                font-size: 1em; /* Garante que os labels sejam bem visíveis */
                margin-bottom: 5px;
            }

            button {
                width: 100%; /* Faz com que os botões ocupem a largura total */
                margin: 8px 0; /* Aumenta a margem vertical entre botões */
                padding: 15px; /* Aumenta o padding dos botões para facilitar o toque */
                font-size: 1.05em; /* Ajusta o tamanho da fonte dos botões */
            }

            .status, .log-header {
                font-size: 1em; /* Ajusta o tamanho do status e cabeçalho do log */
            }

            #logOutput {
                max-height: 300px; /* Reduz a altura máxima do log para telas menores */
                padding: 10px;
                font-size: 0.85em; /* Reduz a fonte do log para caber mais */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Painel de Procura do MarketRoxo</h1>
        <div class="form-group">
            <label for="keywords">Palavras-chave (separadas por vírgula):</label>
            <input type="text" id="keywords" value="{{ keywords_list }}">
        </div>
        <div class="form-group">
            <label for="negativeKeywords">Palavras-chave negativas (separadas por vírgula):</label>
            <input type="text" id="negativeKeywords" value="{{ negative_keywords_list }}">
        </div>
        <div class="form-group">
            <label for="token">Token do Telegram:</label>
            <input type="password" id="token" value="{{ token }}" autocomplete="new-password">
        </div>
        <div class="form-group">
            <label for="chatInput">ID do Chat ou Número de Telefone:</label>
            <input type="text" id="chatInput" value="{{ chat_input }}">
        </div>
        <div class="form-group">
            <label for="interval_monitor">Tempo entre intervalos de Varredura (minutos):</label>
            <p>Tempo longo de intervalo entre a varredura de múltiplas páginas.</p>
            <input type="number" id="interval_monitor" value="{{ interval_monitor }}" min="1">
        </div>
        <div class="form-group">
            <label for="batch_size">Anúncios por mensagem:</label>
            <p>Quantos anúncios o programa vai enviar por mensagem no Telegram.</p>
            <p>Com 1 mensagem, serão exibidas as miniaturas(fotos) dos anúncios. </p>
            <input type="number" id="batch_size" value="{{ batch_size }}" min="1" max="18">
        </div>
        <div class="form-group">
            <label for="pageDepth">Profundidade de páginas:</label>
            <p>Quantas páginas a varredura deve procurar, além da página 1.</p>
            <p>Após obter muitos resultados, se a intenção for apenas atualizar, é recomendável reduzir.</p>
            <input type="number" id="pageDepth" value="{{ page_depth }}" min="1">
        </div>
        <div class="form-group">
            <label for="retryAttempts">Tentativas até sucesso:</label>
            <p>Quantas vezes ele deve repetir uma chamada de página para tentar burlar bloqueios.</p>
            <input type="number" id="retryAttempts" value="{{ retry_attempts }}" min="1">
        </div>
        <div class="form-group">
            <label for="minRepeatTime">Tempo mínimo p/ repetir (segundos):</label>
            <p>Tempo mínimo entre tentativas de repetição, para evitar bloqueios.</p>
            <input type="number" id="minRepeatTime" value="{{ min_repeat_time }}" min="1">
        </div>
        <div class="form-group">
            <label for="maxRepeatTime">Tempo máximo p/ repetir (segundos):</label>
            <p>Tempo máximo entre tentativas de repetição, para evitar bloqueios.</p>
            <input type="number" id="maxRepeatTime" value="{{ max_repeat_time }}" min="1">
        </div>
        <div class="form-group">
            <label for="allowKeywordSubsets">Permitir subconjuntos das palavras-chave:</label>
            <p> Cuidado ao usar: com proxy, isso faz mais chamadas e gasta mais créditos. Bom para tentar achar resultados diferentes.</p>
            <input type="checkbox" id="allowKeywordSubsets" {{ 'checked' if allow_keyword_subsets else '' }}>
        </div>
        <h2>Controle do monitor de procura </h2>
        <p>Ao trocar valores é bom parar para interromper qualquer busca, e iniciar após. Sem iniciar os valores novos não são salvos no servidor. </p>
        <button id="startBtn" onclick="startMonitoring()">Iniciar Monitoramento</button>
        <button id="stopBtn" onclick="stopMonitoring()">Parar Monitoramento</button>
        <br>
        <button id="downloadHashBtn" style="background-color:#1976D2;color:white;" onclick="window.open('/download-hash-file','_blank')">⬇️ Baixar Hash File</button>
        <button id="archiveLogBtn" style="background-color:#388e3c;color:white;" onclick="fetch('/archive_log', {method: 'GET'}).then(r => r.json()).then(data => alert(data.message)).catch(e => alert('Erro ao arquivar log: ' + e));">🆕 Arquivar Log Atual</button>
        <button id="downloadLogsBtn" style="background-color:#6d4c41;color:white;" onclick="window.open('/download-logs','_blank')">📦 Baixar Todos Logs</button>
        <br>
        <span id="autoUpdateStatus" class="status">Carregando logs...</span>
        <div class="log-header">Logs do Sistema (Atualização Automática)</div>
        <pre id="logOutput">Carregando logs...</pre>
    </div>
    <script>
        let logUpdateInterval = null;

        // Função para iniciar atualização automática dos logs
        function startAutoUpdate() {
            if (!logUpdateInterval) {
                logUpdateInterval = setInterval(fetchLogs, 2000); // Atualiza a cada 2 segundos
                document.getElementById('autoUpdateStatus').textContent = 'Atualização automática: Ativada';
            }
        }

        // Função para parar atualização automática
        function stopAutoUpdate() {
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
                document.getElementById('autoUpdateStatus').textContent = 'Atualização automática: Desativada';
            }
        }

        // Função para buscar os logs
        function fetchLogs() {
            fetch('/logs', {
                headers: {
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao carregar logs: ' + response.status);
                }
                return response.text();
            })
            .then(data => {
                const logOutput = document.getElementById('logOutput');
                // Filter out lines containing "GET /logs HTTP/1.1" 200
                const filteredData = data.split('\n').filter(line => !line.includes('GET /logs HTTP/1.1')).join('\n');
                logOutput.textContent = filteredData || 'Nenhum log disponível';
                // Remove or comment out the auto-scroll line
                // logOutput.scrollTop = logOutput.scrollHeight;
            })
            .catch(error => {
                console.error('Erro ao carregar logs:', error);
                document.getElementById('logOutput').textContent = 'Erro ao carregar logs: ' + error.message;
            });
        }

        function startMonitoring() {
            const data = {
                keywords_list: document.getElementById('keywords').value,
                negative_keywords_list: document.getElementById('negativeKeywords').value,
                token: document.getElementById('token').value,
                chat_input: document.getElementById('chatInput').value,
                interval_monitor: document.getElementById('interval_monitor').value,
                batch_size: document.getElementById('batch_size').value,
                page_depth: document.getElementById('pageDepth').value,
                retry_attempts: document.getElementById('retryAttempts').value,
                min_repeat_time: document.getElementById('minRepeatTime').value,
                max_repeat_time: document.getElementById('maxRepeatTime').value,
                allow_subset: document.getElementById('allowKeywordSubsets').checked
            };
            
            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                // Os logs já estão sendo atualizados automaticamente
            })
            .catch(error => {
                console.error('Erro ao iniciar monitoramento:', error);
                alert('Erro ao iniciar monitoramento: ' + error.message);
            });
        }

        function stopMonitoring() {
            fetch('/stop', {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                // Os logs continuam sendo atualizados automaticamente
            })
            .catch(error => {
                console.error('Erro ao parar monitoramento:', error);
                alert('Erro ao parar monitoramento: ' + error.message);
            });
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página carregada, iniciando atualização automática de logs...');
            fetchLogs(); // Carrega os logs imediatamente
            startAutoUpdate(); // Inicia a atualização automática
        });

        // Parar a atualização quando a página for fechada/recarregada
        window.addEventListener('beforeunload', function() {
            stopAutoUpdate();
        });
    </script>
</body>
</html>